{% extends "base.html" %}

{% block head %}
<!-- Add debugging console styles -->
<style>
    #debug-console {
        display: none;
        position: fixed;
        bottom: 10px;
        right: 10px;
        width: 300px;
        max-height: 300px;
        overflow-y: auto;
        background: rgba(0,0,0,0.8);
        color: #fff;
        padding: 10px;
        font-family: monospace;
        z-index: 9999;
        border-radius: 5px;
    }
    #debug-toggle {
        position: fixed;
        bottom: 10px;
        right: 10px;
        background: #6366F1;
        color: white;
        border: none;
        padding: 5px 10px;
        border-radius: 5px;
        cursor: pointer;
        z-index: 10000;
    }
</style>
{% endblock %}

{% block content %}
<!-- Hero Section -->
<div class="bg-white">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-12 md:py-24">
        <div class="text-center">
            <h1 class="text-4xl font-extrabold text-gray-900 sm:text-5xl md:text-6xl">
                <span class="block">Shrink your avatar to</span>
                <span class="block text-indigo-600">70,000 polygons in 20 seconds</span>
            </h1>
            <p class="mt-3 max-w-md mx-auto text-base text-gray-500 sm:text-lg md:mt-5 md:text-xl md:max-w-3xl">
                Optimize 3D models for VRChat, game mods, and NFTs without Blender. Fast, easy, and animation-safe.
            </p>
            <div class="mt-5 max-w-md mx-auto sm:flex sm:justify-center md:mt-8">
                <div class="rounded-md shadow">
                    <a href="#upload" class="w-full flex items-center justify-center px-8 py-3 border border-transparent text-base font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700 md:py-4 md:text-lg md:px-10">
                        Upload & Preview
                    </a>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Features Section -->
<div id="features" class="py-12 bg-gray-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="lg:text-center">
            <h2 class="text-base text-indigo-600 font-semibold tracking-wide uppercase">Features</h2>
            <p class="mt-2 text-3xl leading-8 font-extrabold tracking-tight text-gray-900 sm:text-4xl">
                Smart Optimization for 3D Creators
            </p>
        </div>

        <div class="mt-10">
            <dl class="space-y-10 md:space-y-0 md:grid md:grid-cols-3 md:gap-x-8 md:gap-y-10">
                <div class="relative">
                    <dt>
                        <div class="absolute flex items-center justify-center h-12 w-12 rounded-md bg-indigo-500 text-white">
                            <i class="fas fa-cube"></i>
                        </div>
                        <p class="ml-16 text-lg leading-6 font-medium text-gray-900">No Blender Required</p>
                    </dt>
                    <dd class="mt-2 ml-16 text-base text-gray-500">
                        Upload your models directly through your browser. No software installation or technical knowledge needed.
                    </dd>
                </div>

                <div class="relative">
                    <dt>
                        <div class="absolute flex items-center justify-center h-12 w-12 rounded-md bg-indigo-500 text-white">
                            <i class="fas fa-running"></i>
                        </div>
                        <p class="ml-16 text-lg leading-6 font-medium text-gray-900">Rig & Animation Safe</p>
                    </dt>
                    <dd class="mt-2 ml-16 text-base text-gray-500">
                        Our optimization preserves rigs and animations, so your characters will move naturally with fewer polygons.
                    </dd>
                </div>

                <div class="relative">
                    <dt>
                        <div class="absolute flex items-center justify-center h-12 w-12 rounded-md bg-indigo-500 text-white">
                            <i class="fas fa-shield-alt"></i>
                        </div>
                        <p class="ml-16 text-lg leading-6 font-medium text-gray-900">Privacy First</p>
                    </dt>
                    <dd class="mt-2 ml-16 text-base text-gray-500">
                        All files are automatically deleted after 24 hours. Your models never leave our secure servers.
                    </dd>
                </div>
            </dl>
        </div>
    </div>
</div>

<!-- Upload & Preview Section -->
<div id="upload" class="py-12 bg-white">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="lg:text-center">
            <h2 class="text-base text-indigo-600 font-semibold tracking-wide uppercase">Try It Now</h2>
            <p class="mt-2 text-3xl leading-8 font-extrabold tracking-tight text-gray-900 sm:text-4xl">
                Upload Your Model
            </p>
            <p class="mt-4 max-w-2xl text-xl text-gray-500 lg:mx-auto">
                Drop your GLB, FBX, or GLTF file to see a preview with reduced polygons. Purchase to download the optimized version.
            </p>
        </div>

        <div class="mt-10 max-w-3xl mx-auto">
            <!-- File Upload Drop Zone -->
            <div id="drop-zone" class="drop-zone p-10 text-center cursor-pointer">
                <div id="drop-zone-content">
                    <i class="fas fa-cloud-upload-alt text-4xl text-indigo-500 mb-3"></i>
                    <p class="text-gray-700">Drag & drop your 3D model here or click to browse</p>
                    <p class="text-sm text-gray-500 mt-2">Supports GLB, FBX, GLTF (Max 100MB)</p>
                </div>
                <input type="file" id="file-input" class="hidden" accept=".glb,.fbx,.gltf">
            </div>
            
            <!-- Upload Progress -->
            <div id="upload-progress" class="mt-4 hidden">
                <div class="w-full bg-gray-200 rounded-full h-2.5">
                    <div id="progress-bar" class="bg-indigo-600 h-2.5 rounded-full" style="width: 0%"></div>
                </div>
                <p id="progress-text" class="text-sm text-gray-600 mt-2">Uploading... 0%</p>
            </div>
            
            <!-- Preview Container (hidden initially) -->
            <div id="preview-container" class="mt-8 hidden">
                <div class="bg-white shadow overflow-hidden sm:rounded-lg">
                    <div class="px-4 py-5 sm:px-6 flex justify-between items-center">
                        <div>
                            <h3 class="text-lg leading-6 font-medium text-gray-900">Model Preview</h3>
                            <p class="mt-1 max-w-2xl text-sm text-gray-500">
                                <span class="inline-flex items-center font-medium text-indigo-800 bg-indigo-100 px-2 py-0.5 rounded-full text-xs mr-1">
                                    Sample preview
                                </span>
                                <span class="text-xs">Use Update Preview button to see different reduction levels</span>
                            </p>
                        </div>
                        <a id="view-fullscreen" href="#" class="text-indigo-600 hover:text-indigo-800">
                            <i class="fas fa-expand"></i> Full Screen
                        </a>
                    </div>
                    <div class="border-t border-gray-200">
                        <div class="canvas-container relative" id="preview-canvas">
                            <!-- Three.js canvas will be inserted here -->
                            <div class="absolute top-2 left-2 bg-black bg-opacity-50 text-white px-3 py-1 rounded-lg z-10" id="vertex-count">
                                Original: <span id="original-count">0</span> | Reduced: <span id="reduced-count">0</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Target Triangle Slider -->
                <div class="mt-6">
                    <label for="target-slider" class="block text-sm font-medium text-gray-700">Target Triangle Count for Final Export</label>
                    <div class="flex items-center mb-2">
                        <input type="range" id="target-slider" name="target-slider" min="1000" max="100000" step="100" value="10000" 
                            class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer">
                        <div class="ml-3 w-24 text-sm font-bold text-indigo-600 border border-indigo-200 rounded px-2 py-1 bg-indigo-50">
                            <span id="current-target">10,000</span>
                        </div>
                    </div>
                    <div class="flex justify-between text-xs text-gray-500 mb-3">
                        <span>1,000</span>
                        <span>50,000</span>
                        <span>100,000</span>
                    </div>
                    <div class="flex justify-between items-center mt-3">
                        <button id="update-preview-btn" class="px-3 py-1.5 border border-indigo-500 text-indigo-600 rounded-md text-sm font-medium hover:bg-indigo-50 transition">
                            <i class="fas fa-sync-alt mr-1"></i> Update Preview
                        </button>
                        <div class="text-xs text-gray-500">
                            See how your model looks at this triangle count
                        </div>
                    </div>
                    <div class="mt-2 p-2 bg-blue-50 rounded-md border border-blue-200">
                        <p class="text-sm text-blue-800">
                            <i class="fas fa-info-circle mr-1"></i> 
                            Use the slider to set triangle count and click "Update Preview" to see the result.
                            Purchase to download the final optimized model.
                        </p>
                    </div>
                </div>
                
                <!-- Optimize Button -->
                <div class="mt-8 flex justify-center">
                    <div id="purchase-options" class="grid grid-cols-1 md:grid-cols-2 gap-4 w-full">
                        <a href="/checkout/EXPORT_1" class="flex items-center justify-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">
                            Single Export ($4)
                        </a>
                        <a href="/checkout/CREATOR_MONTH" class="flex items-center justify-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-green-600 hover:bg-green-700">
                            Unlimited for 30 Days ($25)
                        </a>
                    </div>
                    
                    <!-- For authenticated users (hidden initially) -->
                    <button id="optimize-button" class="hidden w-full flex items-center justify-center px-4 py-2 border border-transparent rounded-md shadow-sm text-sm font-medium text-white bg-indigo-600 hover:bg-indigo-700">
                        Optimize Now
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Pricing Section -->
<div id="pricing" class="py-12 bg-gray-50">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="lg:text-center">
            <h2 class="text-base text-indigo-600 font-semibold tracking-wide uppercase">Pricing</h2>
            <p class="mt-2 text-3xl leading-8 font-extrabold tracking-tight text-gray-900 sm:text-4xl">
                Simple & Transparent
            </p>
            <p class="mt-4 max-w-2xl text-xl text-gray-500 lg:mx-auto">
                Choose the plan that works for your needs. No hidden fees.
            </p>
        </div>

        <div class="mt-10 max-w-lg mx-auto grid gap-5 lg:grid-cols-2 lg:max-w-4xl">
            <!-- Single Export Plan -->
            <div class="bg-white shadow rounded-lg overflow-hidden">
                <div class="px-6 py-8">
                    <div class="flex items-center">
                        <h3 class="text-2xl font-bold text-gray-900">Single Export</h3>
                        <span class="ml-3 inline-flex items-center px-3 py-0.5 rounded-full text-sm font-medium bg-blue-100 text-blue-800">
                            Popular
                        </span>
                    </div>
                    <div class="mt-4 flex items-baseline text-6xl font-extrabold">
                        $4
                        <span class="ml-1 text-2xl font-medium text-gray-500">per model</span>
                    </div>
                    <p class="mt-5 text-lg text-gray-500">
                        Perfect for one-time optimization needs.
                    </p>
                </div>
                <div class="px-6 pt-6 pb-8">
                    <ul class="space-y-4">
                        <li class="flex items-start">
                            <div class="flex-shrink-0">
                                <i class="fas fa-check text-green-500"></i>
                            </div>
                            <p class="ml-3 text-base text-gray-700">
                                Single 3D model export
                            </p>
                        </li>
                        <li class="flex items-start">
                            <div class="flex-shrink-0">
                                <i class="fas fa-check text-green-500"></i>
                            </div>
                            <p class="ml-3 text-base text-gray-700">
                                Full resolution download
                            </p>
                        </li>
                        <li class="flex items-start">
                            <div class="flex-shrink-0">
                                <i class="fas fa-check text-green-500"></i>
                            </div>
                            <p class="ml-3 text-base text-gray-700">
                                24-hour access to download
                            </p>
                        </li>
                    </ul>
                    <div class="mt-8">
                        <a href="/checkout/EXPORT_1" class="w-full flex items-center justify-center px-5 py-3 border border-transparent text-base font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">
                            Get Started
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- Unlimited Plan -->
            <div class="bg-white shadow rounded-lg overflow-hidden border-2 border-indigo-500">
                <div class="px-6 py-8">
                    <div class="flex items-center">
                        <h3 class="text-2xl font-bold text-gray-900">Creator Plan</h3>
                        <span class="ml-3 inline-flex items-center px-3 py-0.5 rounded-full text-sm font-medium bg-indigo-100 text-indigo-800">
                            Best Value
                        </span>
                    </div>
                    <div class="mt-4 flex items-baseline text-6xl font-extrabold">
                        $25
                        <span class="ml-1 text-2xl font-medium text-gray-500">/ 30 days</span>
                    </div>
                    <p class="mt-5 text-lg text-gray-500">
                        For creators who need multiple optimizations.
                    </p>
                </div>
                <div class="px-6 pt-6 pb-8">
                    <ul class="space-y-4">
                        <li class="flex items-start">
                            <div class="flex-shrink-0">
                                <i class="fas fa-check text-green-500"></i>
                            </div>
                            <p class="ml-3 text-base text-gray-700">
                                <strong>Unlimited</strong> model exports
                            </p>
                        </li>
                        <li class="flex items-start">
                            <div class="flex-shrink-0">
                                <i class="fas fa-check text-green-500"></i>
                            </div>
                            <p class="ml-3 text-base text-gray-700">
                                Priority processing
                            </p>
                        </li>
                        <li class="flex items-start">
                            <div class="flex-shrink-0">
                                <i class="fas fa-check text-green-500"></i>
                            </div>
                            <p class="ml-3 text-base text-gray-700">
                                30 days of unlimited access
                            </p>
                        </li>
                    </ul>
                    <div class="mt-8">
                        <a href="/checkout/CREATOR_MONTH" class="w-full flex items-center justify-center px-5 py-3 border border-transparent text-base font-medium rounded-md text-white bg-indigo-600 hover:bg-indigo-700">
                            Get Started
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Debug Console -->
<button id="debug-toggle">Debug</button>
<div id="debug-console"></div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', () => {
        const dropZone = document.getElementById('drop-zone');
        const fileInput = document.getElementById('file-input');
        const uploadProgress = document.getElementById('upload-progress');
        const progressBar = document.getElementById('progress-bar');
        const progressText = document.getElementById('progress-text');
        const previewContainer = document.getElementById('preview-container');
        const targetSlider = document.getElementById('target-slider');
        const currentTarget = document.getElementById('current-target');
        const originalCount = document.getElementById('original-count');
        const reducedCount = document.getElementById('reduced-count');
        const optimizeButton = document.getElementById('optimize-button');
        const purchaseOptions = document.getElementById('purchase-options');
        
        // Debug console elements
        const debugToggle = document.getElementById('debug-toggle');
        const debugConsole = document.getElementById('debug-console');
        
        // Toggle debug console
        debugToggle.addEventListener('click', () => {
            debugConsole.style.display = debugConsole.style.display === 'none' ? 'block' : 'none';
        });
        
        // Debug log function
        function debugLog(message) {
            const logLine = document.createElement('div');
            logLine.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            debugConsole.appendChild(logLine);
            debugConsole.scrollTop = debugConsole.scrollHeight;
            console.log(message);
        }
        
        let jobId = null;
        let fileToUpload = null;
        
        // Initialize Three.js variables
        let scene, camera, renderer, controls, model;
        
        // Check if user is authenticated
        if (isAuthenticated()) {
            optimizeButton.classList.remove('hidden');
            purchaseOptions.classList.add('hidden');
        }
        
        // Handle file selection
        function handleFile(file) {
            if (!file) return;
            
            const fileExtension = file.name.split('.').pop().toLowerCase();
            if (!['glb', 'fbx', 'gltf'].includes(fileExtension)) {
                alert('Please upload a GLB, FBX, or GLTF file');
                return;
            }
            
            if (file.size > 100 * 1024 * 1024) {
                alert('File size exceeds 100MB limit');
                return;
            }
            
            fileToUpload = file;
            uploadFile(file);
        }
        
        // Upload file to server
        function uploadFile(file) {
            const formData = new FormData();
            formData.append('file', file);
            
            const xhr = new XMLHttpRequest();
            
            xhr.open('POST', '/api/preview');
            
            xhr.upload.addEventListener('progress', (event) => {
                if (event.lengthComputable) {
                    const percentComplete = Math.round((event.loaded / event.total) * 100);
                    progressBar.style.width = percentComplete + '%';
                    progressText.textContent = `Uploading... ${percentComplete}%`;
                }
            });
            
            xhr.onload = function() {
                if (xhr.status === 200) {
                    try {
                        const response = JSON.parse(xhr.responseText);
                        jobId = response.job_id;
                        
                        debugLog(`Upload response: ${JSON.stringify(response)}`);
                        
                        // If status is already "completed" (local development), display preview
                        if (response.status === "completed") {
                            debugLog("Job already completed (local development mode)");
                            progressText.textContent = 'Processing complete!';
                            previewContainer.classList.remove('hidden');
                            pollJobStatus(jobId); // Still poll once to get the preview URL
                        } else {
                            // Poll for job status
                            debugLog("Starting polling for job status");
                            pollJobStatus(jobId);
                        }
                    } catch (e) {
                        debugLog(`Error parsing response: ${e.message}`);
                        alert('Error processing server response');
                    }
                } else {
                    debugLog(`Upload failed with status ${xhr.status}: ${xhr.responseText}`);
                    alert('Upload failed. Please try again.');
                    uploadProgress.classList.add('hidden');
                }
            };
            
            xhr.onerror = function() {
                debugLog(`Network error during upload`);
                alert('Upload failed. Please try again.');
                uploadProgress.classList.add('hidden');
            };
            
            uploadProgress.classList.remove('hidden');
            xhr.send(formData);
        }
        
        // Poll job status
        function pollJobStatus(id) {
            debugLog(`Polling status for job ${id}`);
            
            fetch(`/api/status/${id}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    debugLog(`Status response: ${JSON.stringify(data)}`);
                    
                    if (data.status === 'completed') {
                        progressText.textContent = 'Processing complete!';
                        
                        // Display preview
                        previewContainer.classList.remove('hidden');
                        
                        // Use our updatePreviewDisplay function for consistent handling
                        updatePreviewDisplay(data);
                    } else if (data.status === 'failed') {
                        progressText.textContent = `Error: ${data.error_message || 'Processing failed'}`;
                        debugLog(`Job failed: ${data.error_message || 'Unknown error'}`);
                    } else {
                        progressText.textContent = 'Processing...';
                        // Continue polling if still processing
                        setTimeout(() => pollJobStatus(id), 2000);
                    }
                })
                .catch(error => {
                    debugLog(`Error polling job status: ${error.message}`);
                    console.error('Error polling job status:', error);
                    // Retry after delay
                    setTimeout(() => pollJobStatus(id), 5000);
                });
        }
        
        // Initialize 3D preview
        function initPreview(modelUrl) {
            try {
                debugLog("Starting initPreview with Three.js version: " + THREE.REVISION);
                const container = document.getElementById('preview-canvas');
                
                // Check if required components exist
                debugLog("Checking Three.js components: " + 
                    "Scene: " + (typeof THREE.Scene !== 'undefined') + 
                    ", WebGLRenderer: " + (typeof THREE.WebGLRenderer !== 'undefined') +
                    ", OrbitControls: " + (typeof THREE.OrbitControls !== 'undefined') +
                    ", GLTFLoader: " + (typeof THREE.GLTFLoader !== 'undefined'));
                
                // Make sure vertex count element is preserved
                const vertexCountEl = document.getElementById('vertex-count');
                if (vertexCountEl) {
                    vertexCountEl.style.display = 'block';
                }
                
                // Clear container while preserving vertex count element
                const childNodes = Array.from(container.childNodes);
                for (const child of childNodes) {
                    if (child !== vertexCountEl) {
                        container.removeChild(child);
                    }
                }
                
                // Initialize Three.js scene
                scene = new THREE.Scene();
                scene.background = new THREE.Color(0xf3f4f6);
                
                // Camera
                camera = new THREE.PerspectiveCamera(45, container.clientWidth / container.clientHeight, 0.1, 1000);
                camera.position.set(0, 1, 5);
                
                // Renderer
                renderer = new THREE.WebGLRenderer({ antialias: true });
                renderer.setSize(container.clientWidth, container.clientHeight);
                renderer.outputEncoding = THREE.sRGBEncoding;
                renderer.shadowMap.enabled = true;
                container.appendChild(renderer.domElement);
                
                // Controls
                debugLog("Creating OrbitControls");
                controls = new THREE.OrbitControls(camera, renderer.domElement);
                controls.enableDamping = true;
                controls.dampingFactor = 0.05;
                
                // Lights
                const ambientLight = new THREE.AmbientLight(0xffffff, 0.5);
                scene.add(ambientLight);
                
                const directionalLight = new THREE.DirectionalLight(0xffffff, 1);
                directionalLight.position.set(1, 1, 1);
                scene.add(directionalLight);
                
                // Load model
                debugLog("Creating GLTFLoader");
                const loader = new THREE.GLTFLoader();
                debugLog("Loading model: " + modelUrl);
                loader.load(
                    modelUrl,
                    function (gltf) {
                        debugLog("Model loaded successfully");
                        model = gltf.scene;
                        
                        // Center model
                        const box = new THREE.Box3().setFromObject(model);
                        const center = box.getCenter(new THREE.Vector3());
                        const size = box.getSize(new THREE.Vector3());
                        
                        // Reset model position to center
                        model.position.x = -center.x;
                        model.position.y = -center.y;
                        model.position.z = -center.z;
                        
                        // Adjust camera
                        const maxDim = Math.max(size.x, size.y, size.z);
                        camera.position.set(0, maxDim / 2, maxDim * 2);
                        camera.lookAt(0, 0, 0);
                        
                        // Add model to scene
                        scene.add(model);
                        
                        // Add watermark
                        addWatermark();
                        
                        // Start animation loop
                        animate();
                    },
                    function (xhr) {
                        // Progress callback
                        debugLog("Loading progress: " + Math.round((xhr.loaded / xhr.total) * 100) + "%");
                    },
                    function (error) {
                        debugLog("Error loading model: " + error);
                        console.error('Error loading model:', error);
                    }
                );
                
                // Handle window resize
                window.addEventListener('resize', onWindowResize);
            } catch (error) {
                debugLog("Error in initPreview: " + error.message);
                console.error("Error in initPreview:", error);
            }
        }
        
        // Add watermark to preview
        function addWatermark() {
            const canvas = renderer.domElement;
            const context = canvas.getContext('2d');
            
            // Add watermark in animation loop
            renderer.domElement.style.position = 'relative';
            const watermarkOverlay = document.createElement('div');
            watermarkOverlay.style.position = 'absolute';
            watermarkOverlay.style.top = '0';
            watermarkOverlay.style.left = '0';
            watermarkOverlay.style.width = '100%';
            watermarkOverlay.style.height = '100%';
            watermarkOverlay.style.pointerEvents = 'none';
            watermarkOverlay.style.background = 'url("/static/images/watermark.png") repeat';
            watermarkOverlay.style.opacity = '0.2';
            renderer.domElement.parentNode.appendChild(watermarkOverlay);
        }
        
        // Handle window resize
        function onWindowResize() {
            const container = document.getElementById('preview-canvas');
            camera.aspect = container.clientWidth / container.clientHeight;
            camera.updateProjectionMatrix();
            renderer.setSize(container.clientWidth, container.clientHeight);
        }
        
        // Animation loop
        function animate() {
            requestAnimationFrame(animate);
            controls.update();
            renderer.render(scene, camera);
        }
        
        // Event: Drag over
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('drag-over');
        });
        
        // Event: Drag leave
        dropZone.addEventListener('dragleave', () => {
            dropZone.classList.remove('drag-over');
        });
        
        // Event: Drop
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('drag-over');
            
            if (e.dataTransfer.files.length) {
                handleFile(e.dataTransfer.files[0]);
            }
        });
        
        // Event: Click to select file
        dropZone.addEventListener('click', () => {
            fileInput.click();
        });
        
        // Event: File selected
        fileInput.addEventListener('change', () => {
            if (fileInput.files.length) {
                handleFile(fileInput.files[0]);
            }
        });
        
        // Event: Target slider change
        targetSlider.addEventListener('input', () => {
            const value = targetSlider.value;
            currentTarget.textContent = parseInt(value).toLocaleString();
            
            // Don't update the preview text - it's a fixed preview
            
            // Add visual feedback that this is just a target setting
            const sliderFeedback = document.getElementById('slider-feedback');
            if (!sliderFeedback) {
                const feedbackEl = document.createElement('div');
                feedbackEl.id = 'slider-feedback';
                feedbackEl.className = 'text-xs text-indigo-600 font-medium mt-1 transition-opacity duration-1000';
                feedbackEl.textContent = `Set to ${parseInt(value).toLocaleString()} triangles. Click "Update Preview" to see this reduction level.`;
                document.querySelector('.mt-6').appendChild(feedbackEl);
                
                // Fade out after 3 seconds
                setTimeout(() => {
                    feedbackEl.style.opacity = '0';
                    setTimeout(() => {
                        if (feedbackEl.parentNode) {
                            feedbackEl.parentNode.removeChild(feedbackEl);
                        }
                    }, 1000);
                }, 3000);
            }
        });
        
        // Event: Optimize button click
        optimizeButton.addEventListener('click', () => {
            if (!fileToUpload) {
                alert('Please upload a file first');
                return;
            }
            
            const token = getToken();
            if (!token) {
                alert('Please log in to optimize models');
                return;
            }
            
            const formData = new FormData();
            formData.append('file', fileToUpload);
            formData.append('target_triangles', targetSlider.value);
            
            fetch('/api/optimize', {
                method: 'POST',
                headers: {
                    'Authorization': `Bearer ${token}`
                },
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Optimization failed');
                }
                return response.json();
            })
            .then(data => {
                alert('Optimization job queued! Job ID: ' + data.job_id);
                // Redirect to dashboard or job status page
            })
            .catch(error => {
                alert('Error: ' + error.message);
            });
        });
        
        // Event: Update Preview button click
        const updatePreviewBtn = document.getElementById('update-preview-btn');
        updatePreviewBtn.addEventListener('click', () => {
            if (!fileToUpload) {
                alert('Please upload a file first');
                return;
            }
            
            // Show loading state
            updatePreviewBtn.disabled = true;
            updatePreviewBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i> Updating...';
            
            // Properly clean up previous Three.js instance if it exists
            if (renderer && renderer.dispose) {
                renderer.dispose();
                // Don't remove from DOM here, we'll handle that in initPreview
            }
            
            // Clear any watermark overlays
            const watermarkOverlays = document.querySelectorAll('#preview-canvas div[style*="watermark"]');
            watermarkOverlays.forEach(overlay => overlay.remove());
            
            // Clear scene
            if (scene) {
                while(scene.children.length > 0){ 
                    scene.remove(scene.children[0]); 
                }
                scene = null;
            }
            
            // Release model resources
            model = null;
            
            // Add loading indicator to canvas (make sure it's inside the canvas but not blocking other elements)
            const loadingOverlay = document.createElement('div');
            loadingOverlay.id = 'preview-loading';
            loadingOverlay.className = 'absolute inset-0 flex items-center justify-center bg-gray-100 bg-opacity-80 z-20';
            loadingOverlay.innerHTML = `
                <div class="text-center">
                    <div class="inline-block animate-spin rounded-full h-8 w-8 border-4 border-indigo-500 border-t-transparent"></div>
                    <p class="mt-2 text-indigo-600 font-medium">Generating preview...</p>
                </div>
            `;
            document.getElementById('preview-canvas').appendChild(loadingOverlay);
            
            // Create form data with the target triangle count
            const formData = new FormData();
            formData.append('file', fileToUpload);
            formData.append('target_triangles', targetSlider.value);
            
            // Request a new preview
            fetch('/api/preview', {
                method: 'POST',
                body: formData
            })
            .then(response => {
                if (!response.ok) {
                    throw new Error('Preview generation failed');
                }
                return response.json();
            })
            .then(data => {
                debugLog(`New preview response: ${JSON.stringify(data)}`);
                jobId = data.job_id;
                
                // If status is already completed, update preview immediately
                if (data.status === "completed" && data.preview_url) {
                    updatePreviewDisplay(data);
                } else {
                    // Poll for job status
                    pollPreviewJobStatus(jobId);
                }
            })
            .catch(error => {
                debugLog(`Error generating preview: ${error.message}`);
                alert('Error: ' + error.message);
                
                // Reset button state
                updatePreviewBtn.disabled = false;
                updatePreviewBtn.innerHTML = '<i class="fas fa-sync-alt mr-1"></i> Update Preview';
                
                // Remove loading overlay
                const loadingOverlay = document.getElementById('preview-loading');
                if (loadingOverlay) {
                    loadingOverlay.remove();
                }
            });
        });
        
        // Poll preview job status
        function pollPreviewJobStatus(id) {
            debugLog(`Polling status for preview job ${id}`);
            
            fetch(`/api/status/${id}`)
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`HTTP error ${response.status}`);
                    }
                    return response.json();
                })
                .then(data => {
                    debugLog(`Preview status response: ${JSON.stringify(data)}`);
                    
                    if (data.status === 'completed') {
                        // Update the preview display
                        updatePreviewDisplay(data);
                    } else if (data.status === 'failed') {
                        debugLog(`Preview job failed: ${data.error_message || 'Unknown error'}`);
                        alert(`Error generating preview: ${data.error_message || 'Unknown error'}`);
                        
                        // Reset button state
                        updatePreviewBtn.disabled = false;
                        updatePreviewBtn.innerHTML = '<i class="fas fa-sync-alt mr-1"></i> Update Preview';
                        
                        // Remove loading overlay
                        const loadingOverlay = document.getElementById('preview-loading');
                        if (loadingOverlay) {
                            loadingOverlay.remove();
                        }
                    } else {
                        // Continue polling if still processing
                        setTimeout(() => pollPreviewJobStatus(id), 2000);
                    }
                })
                .catch(error => {
                    debugLog(`Error polling preview job status: ${error.message}`);
                    console.error('Error polling preview job status:', error);
                    // Retry after delay
                    setTimeout(() => pollPreviewJobStatus(id), 5000);
                });
        }
        
        // Update the preview display with new data
        function updatePreviewDisplay(data) {
            debugLog("Updating preview display with data: " + JSON.stringify(data));
            
            // Ensure we have vertex counts before proceeding
            if (!data.vertex_count_before || !data.vertex_count_after) {
                debugLog("WARNING: Missing vertex count data in preview response");
                data.vertex_count_before = data.vertex_count_before || 0;
                data.vertex_count_after = data.vertex_count_after || 0;
            }
            
            // Update triangle counts in the overlay
            const originalCountEl = document.getElementById('original-count');
            const reducedCountEl = document.getElementById('reduced-count');
            
            if (originalCountEl) {
                originalCountEl.textContent = parseInt(data.vertex_count_before).toLocaleString();
                debugLog("Updated original count to: " + originalCountEl.textContent);
            }
            
            if (reducedCountEl) {
                reducedCountEl.textContent = parseInt(data.vertex_count_after).toLocaleString();
                debugLog("Updated reduced count to: " + reducedCountEl.textContent);
            }
            
            // Also update the preview text header
            const previewTextEl = document.querySelector('.mt-1.max-w-2xl.text-sm.text-gray-500');
            if (previewTextEl) {
                previewTextEl.innerHTML = `
                    <span class="inline-flex items-center font-medium text-indigo-800 bg-indigo-100 px-2 py-0.5 rounded-full text-xs mr-1">
                        ${parseInt(data.vertex_count_after).toLocaleString()} triangles
                     </span>
                     <span class="text-xs">from original ${parseInt(data.vertex_count_before).toLocaleString()}</span>`;
                debugLog("Updated preview header text");
            }
            
            // Initialize 3D preview if we have a URL
            if (data.preview_url && data.preview_url !== '#') {
                debugLog(`Initializing new preview with URL: ${data.preview_url}`);
                initPreview(data.preview_url);
            }
            
            // Reset button state
            updatePreviewBtn.disabled = false;
            updatePreviewBtn.innerHTML = '<i class="fas fa-sync-alt mr-1"></i> Update Preview';
            
            // Remove loading overlay
            const loadingOverlay = document.getElementById('preview-loading');
            if (loadingOverlay) {
                loadingOverlay.remove();
            }
        }
    });
</script>
{% endblock %} 